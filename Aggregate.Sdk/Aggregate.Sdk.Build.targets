<Project>

  <!-- Patched Build Targets -->

  <!-- TODO: Once MSBuild learns that a single project can have multiple outputs, change the targets below not include the output of this project and update the %(OutputPath.MSBuildSourceProjectFile) metadata -->
  <Target
    Name="Build"
    Condition=" '$(_InvalidConfigurationWarning)' != 'true' "
    DependsOnTargets="$(BuildDependsOn)"
    Returns="@(OutputBuildFiles)">
    <ItemGroup>
      <OutputBuildFiles Include="@(TargetPathWithTargetPlatformMoniker)" />
    </ItemGroup>

    <MSBuild
      BuildInParallel="$(BuildInParallel)"
      Projects="@(_MSBuildProjectReferenceExistent)"
      Targets="%(_MSBuildProjectReferenceExistent.Targets)"
      Properties="%(_MSBuildProjectReferenceExistent.SetConfiguration);
                   %(_MSBuildProjectReferenceExistent.SetPlatform);
                   %(_MSBuildProjectReferenceExistent.SetTargetFramework);"
      RemoveProperties="%(_MSBuildProjectReferenceExistent.GlobalPropertiesToRemove)">
      <Output TaskParameter="TargetOutputs" ItemName="OutputBuildFiles" />
    </MSBuild>

    <!-- 
    <ItemGroup>
      <OutputBuildFiles Update="@(OutputBuildFiles)" MSBuildSourceProjectFile="$(MSBuildProjectFile)" />
    </ItemGroup>
    -->
  </Target>

  <Target
    Name="GetTargetPath"
    Condition=" '$(_InvalidConfigurationWarning)' != 'true' "
    DependsOnTargets="PrepareProjectReferences;$(GetTargetPathDependsOn)"
    Returns="@(OutputBuildFiles)">
    <ItemGroup>
      <OutputBuildFiles Include="@(TargetPathWithTargetPlatformMoniker)" />
    </ItemGroup>

    <MSBuild
      BuildInParallel="$(BuildInParallel)"
      Projects="@(_MSBuildProjectReferenceExistent)"
      Targets="GetTargetPath"
      Properties="%(_MSBuildProjectReferenceExistent.SetConfiguration);
                   %(_MSBuildProjectReferenceExistent.SetPlatform);
                   %(_MSBuildProjectReferenceExistent.SetTargetFramework);"
      RemoveProperties="%(_MSBuildProjectReferenceExistent.GlobalPropertiesToRemove)">
      <Output TaskParameter="TargetOutputs" ItemName="OutputBuildFiles" />
    </MSBuild>

    <!-- 
    <ItemGroup>
      <OutputBuildFiles Update="@(OutputBuildFiles)" MSBuildSourceProjectFile="$(MSBuildProjectFile)" />
    </ItemGroup>
    -->
  </Target>
</Project>